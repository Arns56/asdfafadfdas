<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Selfie ‚Üí Share</title>
<style>
  :root{--bg:#000;--accent:#0f0}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--accent);font-family:Arial,Helvetica,sans-serif;display:flex;align-items:center;justify-content:center}
  .card{width:92%;max-width:420px;text-align:center;padding:18px}
  button{background:var(--accent);color:#000;border:none;padding:12px 16px;border-radius:10px;font-size:16px;cursor:pointer}
  #status{margin-bottom:12px}
  a{color:var(--accent)}
  video{display:none}
</style>
</head>
<body>
  <div class="card">
    <div id="status">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Å–µ–ª—Ñ–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</div>
    <button id="btn">üì∏ –°–¥–µ–ª–∞—Ç—å –∏ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
    <div style="height:12px"></div>
    <div id="fallback"></div>
    <video id="preview" playsinline muted></video>
  </div>

<script>
const btn = document.getElementById('btn');
const status = document.getElementById('status');
const fallback = document.getElementById('fallback');

function update(t){ status.textContent = t; console.log(t); }

function dataURLtoBlob(dataurl){
  const parts = dataurl.split(',');
  const mime = parts[0].match(/:(.*?);/)[1];
  const bstr = atob(parts[1]);
  let n = bstr.length;
  const u8 = new Uint8Array(n);
  while(n--) u8[n] = bstr.charCodeAt(n);
  return new Blob([u8], { type: mime });
}

btn.addEventListener('click', async () => {
  btn.disabled = true;
  fallback.innerHTML = '';
  update('1) –ó–∞–ø—Ä–∞—à–∏–≤–∞—é —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω—É—é –∫–∞–º–µ—Ä—É‚Ä¶');

  let stream = null;
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width:{ideal:1280}, height:{ideal:720} }, audio:false });
  } catch (e) {
    update('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ' + (e.message || e));
    btn.disabled = false;
    return;
  }

  const video = document.getElementById('preview');
  video.srcObject = stream;
  try {
    await video.play();
  } catch(e) {
    // –ù–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö play —Ç—Ä–µ–±—É–µ—Ç –∂–µ—Å—Ç–∞ ‚Äî –Ω–æ –º—ã –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∫–ª–∏–∫–∞, –∑–Ω–∞—á–∏—Ç –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –û–ö
    console.warn('video.play error', e);
  }

  // –î–∞–¥–∏–º –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–º–µ—Ä–µ –ø–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä
  await new Promise(r => setTimeout(r, 500));

  const vw = video.videoWidth || 720;
  const vh = video.videoHeight || 1280;

  update('2) –ó–∞—Ö–≤–∞—Ç—ã–≤–∞—é –∫–∞–¥—Ä‚Ä¶');

  // –º–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏
  const maxW = 1080;
  const maxH = 1920;
  const scale = Math.min(1, Math.min(maxW / vw, maxH / vh));
  const w = Math.round(vw * scale);
  const h = Math.round(vh * scale);

  const canvas = document.createElement('canvas');
  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext('2d');

  // –∑–µ—Ä–∫–∞–ª–∏–º (—Å–µ–ª—Ñ–∏)
  ctx.translate(w, 0);
  ctx.scale(-1, 1);
  ctx.drawImage(video, 0, 0, w, h);
  ctx.setTransform(1,0,0,1,0,0);

  // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã
  stream.getTracks().forEach(t => t.stop());

  update('3) –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ‚Ä¶');

  const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
  const blob = dataURLtoBlob(dataUrl);
  const file = new File([blob], `selfie_${Date.now()}.jpg`, { type: 'image/jpeg' });

  // –ü–æ–ø—Ä–æ–±—É–µ–º Web Share API (—Å —Ñ–∞–π–ª–∞–º–∏)
  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    update('4) –û—Ç–∫—Ä—ã–≤–∞—é –¥–∏–∞–ª–æ–≥ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" ‚Äî –≤—ã–±–µ—Ä–∏ Telegram –∏–ª–∏ –¥—Ä—É–≥–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ');
    try {
      await navigator.share({
        files: [file],
        text: '–°–µ–ª—Ñ–∏',
        title: '–°–µ–ª—Ñ–∏'
      });
      update('‚úÖ –ì–æ—Ç–æ–≤–æ ‚Äî —Ñ–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω (–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª).');
    } catch (err) {
      update('‚ùå –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–µ —É–¥–∞–ª–æ—Å—å: ' + (err.message || err));
    }
    btn.disabled = false;
    return;
  }

  // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø—É—Ç—å: —Å—Å—ã–ª–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (—Ñ–æ–ª–ª–±–µ–∫)
  update('4) Web Share API —Å —Ñ–∞–π–ª–∞–º–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤—å –≤—Ä—É—á–Ω—É—é –≤ Telegram');

  // –°–æ–∑–¥–∞—ë–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `selfie_${Date.now()}.jpg`;
  a.textContent = '–°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ (–Ω–∞–∂–º–∏ –∏ –∑–∞—Ç–µ–º –æ—Ç–∫—Ä–æ–π –≤ Telegram)';
  a.style.color = '#0f0';
  a.style.display = 'inline-block';
  a.style.marginTop = '10px';
  fallback.appendChild(a);

  // –ü–æ–¥—Å–∫–∞–∑–∫–∞: –Ω–∞ iPhone ‚Äî "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" —á–µ—Ä–µ–∑ –¥–æ–ª–≥–∏–π —Ç–∞–ø –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ/—Å—Å—ã–ª–∫–µ
  const img = document.createElement('img');
  img.src = url;
  img.alt = 'selfie preview';
  img.style.maxWidth = '100%';
  img.style.marginTop = '10px';
  fallback.appendChild(img);

  btn.disabled = false;
});
</script>
</body>
</html>
